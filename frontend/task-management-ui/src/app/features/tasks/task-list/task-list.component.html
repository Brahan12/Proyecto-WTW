<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Listado de Tareas</h2>

  <div class="d-flex gap-2 align-items-center">

    <select class="form-select w-auto"
            (change)="onStatusChange($event)">
      <option value="">Estado: Todos</option>
      <option value="Pending">Pending</option>
      <option value="InProgress">InProgress</option>
      <option value="Done">Done</option>
    </select>

    <select class="form-select w-auto"
            (change)="onPriorityChange($event)">
      <option value="">Prioridad: Todas</option>
      <option value="Low">Low</option>
      <option value="Medium">Medium</option>
      <option value="High">High</option>
    </select>

    <a class="btn btn-primary" routerLink="/tasks/create">
      + Crear Tarea
    </a>

  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">

    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Título</th>
          <th>Estado</th>
          <th>Usuario</th>
          <th>Creación</th>
          <th>Prioridad</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let t of paginatedTasks; trackBy: trackById">
          <td>{{ t.title }}</td>
          <td>
            <span class="badge bg-secondary" *ngIf="t.status === 'Pending'">Pending</span>
            <span class="badge bg-warning text-dark" *ngIf="t.status === 'InProgress'">InProgress</span>
            <span class="badge bg-success" *ngIf="t.status === 'Done'">Done</span>
          </td>
          <td>{{ getUserLabel(t.userId) }}</td>
          <td>{{ t.createDate | date:'short' }}</td>
          <td>
            <span class="badge bg-secondary" *ngIf="t.priority === 'Low'">Low</span>
            <span class="badge bg-warning text-dark" *ngIf="t.priority === 'Medium'">Medium</span>
            <span class="badge bg-danger" *ngIf="t.priority === 'High'">High</span>
            <span class="text-muted" *ngIf="!t.priority">N/A</span>
          </td>
          <td class="text-center">
            <div class="d-flex flex-column flex-md-row justify-content-center gap-2">

              <button class="btn btn-sm btn-outline-dark"
                      (click)="openDetailModal(t)">
                Ver
              </button>

              <button class="btn btn-sm btn-outline-primary"
                      (click)="openConfirmModal(t, 'InProgress')"
                      [disabled]="t.status !== 'Pending'">
                InProgress
              </button>

              <button class="btn btn-sm btn-outline-success"
                      (click)="openConfirmModal(t, 'Done')"
                      [disabled]="t.status !== 'InProgress'">
                Done
              </button>

            </div>
          </td>
        </tr>

        <tr *ngIf="paginatedTasks.length === 0">
          <td colspan="6" class="text-center text-muted">
            No hay tareas registradas.
          </td>
        </tr>
      </tbody>
    </table>

    <!-- PAGINACIÓN -->
    <nav *ngIf="totalPages() > 1">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="page === 1">
          <button class="page-link" (click)="goToPage(page - 1)">Anterior</button>
        </li>

        <li class="page-item"
            *ngFor="let p of pagesArray()"
            [class.active]="p === page">
          <button class="page-link" (click)="goToPage(p)">{{ p }}</button>
        </li>

        <li class="page-item" [class.disabled]="page === totalPages()">
          <button class="page-link" (click)="goToPage(page + 1)">Siguiente</button>
        </li>
      </ul>
    </nav>

  </div>
</div>

<!-- MODAL -->
<app-confirm-modal
  [show]="showModal"
  title="Confirmación de cambio de estado"
  [message]="'¿Desea cambiar el estado de la tarea a ' + selectedStatus + '?'"
  (confirmed)="confirmChangeStatus()"
  (cancelled)="closeModal()">
</app-confirm-modal>

<app-task-detail-modal
  [show]="showDetailModal"
  [task]="selectedTaskDetail"
  [userLabel]="selectedUserLabel"
  (closed)="closeDetailModal()">
</app-task-detail-modal>
